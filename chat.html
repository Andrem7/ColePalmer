<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Cole Palmer</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="chat-styles.css">
</head>
<body>
    <!-- Authentication Header -->
    <header class="auth-header">
        <div class="auth-container">
            <a href="index.html" class="back-link">‚Üê Back to Home</a>
            <div id="user-info" style="display: none;"></div>
            <button id="auth-button">Sign In</button>
        </div>
    </header>

    <div class="chat-container">
        <div class="chat-header">
            <div class="chat-profile">
                <div class="chat-avatar">CP</div>
                <div class="chat-info">
                    <h2>Cole Palmer</h2>
                    <p class="chat-status">Chelsea FC ‚Ä¢ Online</p>
                </div>
            </div>
        </div>

        <div class="chat-messages" id="chat-messages">
            <div class="message bot-message">
                <div class="message-avatar">CP</div>
                <div class="message-content">
                    <p>Hey there! I'm Cole Palmer. Great to meet you! Ask me anything about my career, training, life at Chelsea, or football in general. What would you like to know?</p>
                    <span class="message-time">Just now</span>
                </div>
            </div>
        </div>

        <div class="chat-input-container">
            <form id="chat-form" class="chat-form">
                <input type="text" id="chat-input" placeholder="Message Cole Palmer..." required>
                <button type="submit" id="send-button">
                    <span class="send-icon">‚Üí</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Loading indicator -->
    <div id="typing-indicator" class="typing-indicator" style="display: none;">
        <div class="message bot-message">
            <div class="message-avatar">CP</div>
            <div class="message-content">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Authentication required modal -->
    <div id="auth-required-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Sign In Required</h2>
            <p>You need to sign in to chat with Cole Palmer.</p>
            <button onclick="window.location.href='index.html'">Go Back to Sign In</button>
        </div>
    </div>

    <script type="module">
        import { auth, getCurrentUser } from './auth.js';
        import { onAuthStateChanged } from 'firebase/auth';
        import { openaiClient } from './openai-client.js';
        
        // Check authentication
        let currentUser = null;
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-required-modal').style.display = 'none';
                initializeChat();
            } else {
                document.getElementById('auth-required-modal').style.display = 'block';
            }
        });
        
        // Chat functionality
        const messagesContainer = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');

        function initializeChat() {
            chatForm.addEventListener('submit', handleSendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage(e);
                }
            });
            
            // Focus on input when page loads
            chatInput.focus();
        }
        
        async function handleSendMessage(e) {
            e.preventDefault();
            
            const message = chatInput.value.trim();
            if (!message || sendButton.disabled) return;
            
            // Clear input and disable send button
            chatInput.value = '';
            sendButton.disabled = true;
            sendButton.innerHTML = '<span class="send-icon">...</span>';
            
            // Add user message to chat
            addMessage(message, 'user');
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Get AI response from OpenAI
                const response = await openaiClient.sendMessage(message);
                
                // Hide typing indicator
                hideTypingIndicator();
                
                // Add AI response to chat
                addMessage(response, 'bot');
                
            } catch (error) {
                console.error('Error getting AI response:', error);
                hideTypingIndicator();
                addMessage("Sorry mate, I'm having some technical difficulties right now. Give me another try in a moment!", 'bot');
            }
            
            // Re-enable send button
            sendButton.disabled = false;
            sendButton.innerHTML = '<span class="send-icon">‚Üí</span>';
            chatInput.focus();
        }
        
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Escape HTML to prevent XSS
            const safeText = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            if (sender === 'user') {
                const userInitial = currentUser.displayName 
                    ? currentUser.displayName.charAt(0).toUpperCase() 
                    : currentUser.email ? currentUser.email.charAt(0).toUpperCase() : 'U';
                    
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <p>${safeText}</p>
                        <span class="message-time">${timeString}</span>
                    </div>
                    <div class="message-avatar">${userInitial}</div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-avatar">CP</div>
                    <div class="message-content">
                        <p>${safeText}</p>
                        <span class="message-time">${timeString}</span>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        function showTypingIndicator() {
            typingIndicator.style.display = 'block';
            messagesContainer.appendChild(typingIndicator);
            scrollToBottom();
        }
        
        function hideTypingIndicator() {
            typingIndicator.style.display = 'none';
            if (typingIndicator.parentNode) {
                typingIndicator.parentNode.removeChild(typingIndicator);
            }
        }
        
        function scrollToBottom() {
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }
        
        // Add some helpful starter messages to guide conversation
        window.addEventListener('load', () => {
            if (currentUser) {
                setTimeout(() => {
                    const starterMessages = [
                        "üí¨ Try asking: 'How's life at Chelsea?'",
                        "‚öΩ Try asking: 'What's your favorite goal you've scored?'",
                        "üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Try asking: 'Tell me about playing for England'",
                        "üèÉ‚Äç‚ôÇÔ∏è Try asking: 'What's your training routine like?'"
                    ];
                    
                    const randomStarter = starterMessages[Math.floor(Math.random() * starterMessages.length)];
                    addMessage(`Some ideas to get us started: ${randomStarter}`, 'bot');
                }, 2000);
            }
        });
    </script>
</body>
</html>